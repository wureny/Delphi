# Delphi Ontology

This folder contains the executable ontology artifacts for Delphi.

## Current modeling stance
1. The ontology is a semantic layer above raw source data, not a direct mirror of storage tables or API payloads.
2. The current market ontology is optimized for agent reasoning, explicit relationship traversal, and future decision-path traceability.
3. The current scope is intentionally limited to Polymarket `crypto` and `finance` markets.
4. Modeling choices are aligned with official Polymarket concepts: an event groups one or more markets, each market is the fundamental tradable proposition, and order book availability depends on `enableOrderBook`.
5. The ontology separates three layers:
   - market semantics
   - market microstructure
   - derived reliability / robust-signal analysis

## Current contents
- `schemas/core-entity-dictionary.md`: human-readable entity definitions and semantic modeling choices.
- `schemas/polymarket-ontology.schema.json`: machine-readable schema contract for the current market ontology.
- `samples/polymarket-sample-bundle.json`: sample bundle aligned with the current schema and generated by the executable pipeline.
- `samples/raw/`: sample Gamma, CLOB, and external-news inputs for the local pipeline.
- `samples/benchmarks/`: labeled benchmark cases and a reserved `live-cases/` archive for real snapshots.
- `samples/multi-agent/`: sample per-agent context packets derived from ontology bundles.
- `mappings/polymarket-field-mapping.json`: multi-source mapping draft informed by official Polymarket docs.
- `schemas/fund-execution-entity-dictionary.md`: fund execution entity definitions.
- `schemas/fund-execution-ontology.schema.json`: machine-readable contract for execution domain.
- `samples/fund-execution-sample-bundle.json`: sample trading and execution bundle.
- `mappings/fund-execution-mapping.json`: mapping from agent decisions/execution logs.

## Current market ontology priorities
1. Make entities and relationships explicit for agents.
2. Keep provenance anchors to raw Polymarket identifiers where needed.
3. Represent settlement at the market level.
4. Add order-book and trade semantics so agents do not over-index on a single displayed price.
5. Output a derived `MarketMicrostructureState` so downstream agents can weight market-implied signals by reliability.
6. Archive thin-book and anomalous live cases for regression, not just hand-written toy examples.
7. Add a repeatable labeling workflow so archived live cases can become benchmark-ready.
8. Use rolling windows and segmented persistence for longer-running stream capture jobs.
9. Avoid uncontrolled expansion to all categories before validation quality is good enough.

## MarketMicrostructureState
The current derived state includes:
- `displayed_probability`
- `robust_probability`
- `book_reliability_score`
- `trade_reliability_score`
- `manipulation_risk_score`
- `signal_weights`
- `depth_imbalance`
- `quote_trade_divergence`
- `explanatory_tags`

The design intent is to give agents a robust market-implied signal that can fall back toward prior market probability when the visible book is shallow, unconfirmed, or dominated by tiny trades.

## Multi-agent bridge
The repo now includes a minimal bridge from ontology bundles into agent-specific packets:
- `scripts/ontology/build_multi_agent_context.py`
- `ontology/samples/multi-agent/polymarket-agent-context-sample.json`

This layer currently prepares:
- `research_agent_packets`
- `strategy_agent_packets`
- `risk_agent_packets`
- `audit_agent_packets`
- `candidate_decisions`

It is the current handoff point between market ontology and the later execution-domain `DecisionRecord` / `Order` / `Execution` chain.

The repo also now includes two minimal pre-orchestration utilities:
- `scripts/ontology/build_decision_records.py`
- `scripts/ontology/evaluate_risk_policy_gate.py`

They are meant to prove that the current ontology and multi-agent context are already sufficient to:
1. produce execution-domain `DecisionRecord` objects, and
2. run a deterministic risk gate,
3. produce minimal `Order` proposals,
even before a full multi-agent runtime exists.

## Related design docs
- `docs/zh/06-Polymarket-市场微观结构与稳健信号设计-v0.1.md`
- `docs/en/06-Polymarket-Microstructure-and-Robust-Signal-Design-v0.1.md`
- `docs/zh/07-Polymarket-工程实现-Handoff-v0.1.md`
- `docs/zh/08-Polymarket-Ontology-多Agent消费契约-v0.1.md`
- `docs/en/08-Polymarket-Ontology-Multi-Agent-Consumption-Contract-v0.1.md`
- `docs/zh/09-Polymarket到多Agent到执行前链路总览-v0.1.md`
- `docs/en/09-Polymarket-to-Multi-Agent-to-Pre-Trade-Flow-Overview-v0.1.md`

## Local pipeline
Build a bundle from local sample inputs:

```bash
python3 scripts/ontology/build_polymarket_ontology.py \
  --gamma-events ontology/samples/raw/polymarket-gamma-events-sample.json \
  --clob-messages ontology/samples/raw/polymarket-clob-market-channel-sample.json \
  --news-signals ontology/samples/raw/polymarket-news-signals-sample.json \
  --output /tmp/polymarket-bundle.generated.json \
  --pretty
```

Run the mapper smoke test:

```bash
python3 scripts/ontology/smoke_test_polymarket_pipeline.py
```

Fetch a public live snapshot:

```bash
python3 scripts/ontology/fetch_polymarket_public_snapshot.py \
  --output-dir /tmp/polymarket-live-raw \
  --limit-events 10
```

Capture a live case library:

```bash
python3 scripts/ontology/capture_polymarket_case_library.py \
  --output-dir /tmp/polymarket-case-library \
  --iterations 6 \
  --interval-seconds 30
```

Export or apply live-case labels:

```bash
python3 scripts/ontology/manage_live_case_labels.py queue \
  --cases-dir /tmp/polymarket-case-library/live-cases \
  --output /tmp/polymarket-case-library/label-worklist.json

python3 scripts/ontology/manage_live_case_labels.py apply \
  --cases-dir /tmp/polymarket-case-library/live-cases \
  --accept-suggested
```

Replay recorded CLOB messages into rolling bundles:

```bash
python3 scripts/ontology/polymarket_stream_capture.py \
  --output-dir /tmp/polymarket-stream-replay \
  --replay-messages ontology/samples/raw/polymarket-clob-market-channel-sample.json \
  --gamma-events ontology/samples/raw/polymarket-gamma-events-sample.json \
  --news-signals ontology/samples/raw/polymarket-news-signals-sample.json \
  --window-seconds 120
```

Run the benchmark:

```bash
python3 scripts/ontology/benchmarks/evaluate_microstructure_cases.py \
  --cases ontology/samples/benchmarks/microstructure-benchmark-cases.json
```

Build multi-agent context:

```bash
python3 scripts/ontology/build_multi_agent_context.py \
  --bundle ontology/samples/polymarket-sample-bundle.json \
  --output /tmp/polymarket-agent-context.json \
  --pretty
```

Build `DecisionRecord` objects:

```bash
python3 scripts/ontology/build_decision_records.py \
  --agent-context ontology/samples/multi-agent/polymarket-agent-context-sample.json \
  --output /tmp/polymarket-decision-records.json \
  --pretty \
  --include-hold
```

Evaluate a simple `RiskPolicy` gate:

```bash
python3 scripts/ontology/evaluate_risk_policy_gate.py \
  --agent-context ontology/samples/multi-agent/polymarket-agent-context-sample.json \
  --execution-bundle ontology/samples/fund-execution-sample-bundle.json \
  --output /tmp/polymarket-risk-gate-report.json \
  --pretty \
  --include-hold
```

Build minimal order proposals:

```bash
python3 scripts/ontology/build_order_proposals.py \
  --decision-records ontology/samples/execution-derived/decision-records-sample.json \
  --risk-gate-report ontology/samples/execution-derived/risk-gate-report-sample.json \
  --execution-bundle ontology/samples/fund-execution-sample-bundle.json \
  --output /tmp/polymarket-order-proposals.json \
  --pretty
```

## Next expected issues
1. Stronger case labeling workflow for archived live cases.
2. Continuous stream deployment and longer-running market capture jobs.
3. Historical calibration of `robust_probability` and risk thresholds against external ground truth.
4. Relationship cardinality and graph constraints beyond basic JSON schema.
5. JSON -> graph export (Neo4j).
6. Execution safety gates and human-in-the-loop approval flow.
